<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stella Sora - Potential Tracker</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f0f13">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="StellaTracker">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3408/3408545.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Orbitron:wght@500;700&display=swap"
        rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">

    <style>
        /* --- CUSTOM STYLES --- */
        :root {
            --primary-glow: #3f51b5;
            --secondary-glow: #e91e63;
            --main-role: #ff9800;
            --supp-role: #03a9f4;

            /* Rarity Colors */
            --rarity-common: #546e7a;
            --rarity-rare: #ff4081;
            --rarity-super: #f50057;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f0f13;
            background-image: radial-gradient(circle at 50% 0%, #1a1a2e 0%, #0f0f13 70%);
            min-height: 100vh;
            overflow-x: hidden;
            /* PWA: Disable pull-to-refresh on mobile */
            overscroll-behavior-y: none;
        }

        h1,
        h2,
        h3,
        h4,
        .navbar-brand {
            font-family: 'Orbitron', sans-serif;
            letter-spacing: 1px;
        }

        /* Navbar */
        .navbar {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(15, 15, 19, 0.95);
            backdrop-filter: blur(10px);
            z-index: 1000;
            padding-top: env(safe-area-inset-top);
            /* iOS Notch Support */
        }

        /* --- POOL & RARITY STYLES --- */
        .pool-section {
            margin-bottom: 8px;
            background: rgba(0, 0, 0, 0.2);
            padding: 6px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .pool-section-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: #888;
            margin-bottom: 4px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .pool-row {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 6px;
        }

        .pool-card {
            aspect-ratio: 2/3;
            cursor: pointer;
            position: relative;
            border-radius: 4px;
            overflow: hidden;
            background: #111;
            transition: transform 0.1s;
            border: 2px solid var(--rarity-common);
            /* Touch Optimizations */
            touch-action: manipulation;
        }

        .pool-card:active {
            transform: scale(0.95);
        }

        /* Better touch feedback */

        .pool-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .pool-card.rare {
            border-color: var(--rarity-rare);
            background: radial-gradient(circle, rgba(255, 64, 129, 0.15) 0%, rgba(0, 0, 0, 1) 100%);
        }

        .pool-card.super {
            border-color: var(--rarity-super);
            box-shadow: 0 0 5px var(--rarity-super);
            animation: core-pulse 2s infinite;
        }

        @keyframes core-pulse {
            0% {
                box-shadow: 0 0 5px var(--rarity-super);
                border-color: #ff80ab;
            }

            50% {
                box-shadow: 0 0 12px var(--rarity-super);
                border-color: #f50057;
            }

            100% {
                box-shadow: 0 0 5px var(--rarity-super);
                border-color: #ff80ab;
            }
        }

        .pool-card.selected {
            opacity: 0.4;
            filter: grayscale(100%);
            pointer-events: none;
            border-style: dashed;
            animation: none;
        }

        /* Filter hidden state */
        .pool-card.hidden {
            display: none !important;
        }

        .pool-section.hidden {
            display: none !important;
        }

        .pool-overlay {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            font-size: 0.6rem;
            text-align: center;
            font-weight: bold;
            padding: 1px 0;
        }

        /* --- DASHBOARD --- */
        .run-card {
            background: #1e1e2d;
            border: 1px solid #333;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .run-card-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }

        .char-icon {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 2px solid #444;
            object-fit: cover;
            background: #000;
        }

        .char-icon.main {
            border-color: var(--main-role);
        }

        .char-icon.supp {
            border-color: var(--supp-role);
        }

        /* Stats Header */
        .stats-bar {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
        }

        .stat-item i {
            margin-right: 5px;
            opacity: 0.7;
        }

        /* Target List */
        .target-list-container {
            flex-grow: 1;
            overflow-y: auto;
            max-height: 400px;
            padding-right: 5px;
            margin-top: 10px;
        }

        .desc-text {
            font-size: 0.75rem;
            color: #aaa;
            margin-top: 4px;
            line-height: 1.2;
            display: block;
        }

        .desc-text span {
            color: #ffeb3b;
            font-weight: bold;
        }

        .cursor-pointer {
            cursor: pointer;
        }

        /* Search Input */
        .pool-search {
            background: #111;
            border: 1px solid #444;
            color: #fff;
            font-size: 16px;
            /* Prevents iOS Zoom on focus */
        }

        .pool-search::placeholder {
            color: #666;
        }

        .pool-search:focus {
            background: #000;
            color: #fff;
            border-color: var(--primary-glow);
            box-shadow: none;
        }

        /* Stats Modal */
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #333;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-val {
            font-family: 'Orbitron', sans-serif;
            color: var(--primary-glow);
            font-weight: bold;
        }

        /* Mobile tweaks */
        @media (max-width: 768px) {
            .navbar-brand {
                font-size: 1rem;
            }

            .btn {
                padding: 5px 10px;
                font-size: 0.8rem;
            }

            .pool-row {
                grid-template-columns: repeat(5, 1fr);
            }
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-expand-lg sticky-top mb-4">
        <div class="container-fluid px-2 px-md-4">
            <a class="navbar-brand text-white" href="#"><i class="fa-solid fa-gamepad me-2"></i>Stella<span
                    class="text-primary">Sora</span></a>
            <div class="d-flex" id="navActions"></div>
        </div>
    </nav>

    <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="handleFileImport(this)">

    <div class="container-fluid px-2 px-md-4 pb-5">

        <div id="viewDashboard" class="animate__animated animate__fadeIn">
            <div class="container">
                <div class="row g-3" id="trackerList"></div>
            </div>
        </div>

        <div id="viewSetup" class="d-none animate__animated animate__fadeInUp">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        <div class="card shadow-lg bg-dark border-secondary">
                            <div class="card-header bg-primary text-white">
                                <h4 class="mb-0">New Run Setup</h4>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Run Name</label>
                                    <input type="text" id="runName" class="form-control"
                                        placeholder="e.g. Abyssal Dungeon Run">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label text-warning"><i class="fa-solid fa-crown me-1"></i>Main
                                        Character</label>
                                    <select id="selectMain" class="form-select"></select>
                                </div>
                                <div class="row">
                                    <div class="col-6 mb-3">
                                        <label class="form-label text-info"><i
                                                class="fa-solid fa-shield-halved me-1"></i>Support 1</label>
                                        <select id="selectSup1" class="form-select"></select>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <label class="form-label text-info"><i
                                                class="fa-solid fa-shield-halved me-1"></i>Support 2</label>
                                        <select id="selectSup2" class="form-select"></select>
                                    </div>
                                </div>
                                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                                    <button class="btn btn-secondary me-md-2" onclick="showDashboard()">Cancel</button>
                                    <button class="btn btn-success" onclick="createTracker()">Start Run</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="viewTracker" class="d-none animate__animated animate__fadeIn">
            <div class="row g-3" id="runColumns"></div>
        </div>

    </div>

    <div class="modal fade" id="statsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary shadow-lg">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-white"><i class="fa-solid fa-chart-pie me-2"></i>Team Stats Summary</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="statsModalBody"></div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        /* --- 0. PWA SERVICE WORKER --- */
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW Registered'))
                    .catch(err => console.log('SW Failed', err));
            });
        }

        /* --- 1. CONFIG & DATA --- */
        const ASSET_BASE_URL = "https://your-storage-service.com/stella-sora/assets/";

        const MAX_LEVEL = 6;
        const BASE_CAP_MAIN = 6;
        const BASE_CAP_SUPP = 5;

        const baseCharacters = [
            { id: "c1", name: "Chitose", element: "Aqua" },
            { id: "c2", name: "Gerie", element: "Terra" },
            { id: "c3", name: "Nazuna", element: "Ventus" },
            { id: "c4", name: "Stella", element: "Ignis" }
        ];

        function generatePotentials() {
            let potentials = [];
            const roles = ['main', 'support'];

            baseCharacters.forEach(char => {
                roles.forEach(role => {
                    for (let i = 1; i <= 19; i++) {
                        let rarity = "common";
                        if ([3, 6, 9, 12, 15, 18].includes(i)) rarity = "rare";
                        if (i === 19) rarity = "super";

                        const imgName = `${char.id}_${role}_${i}.png`;
                        const realUrl = ASSET_BASE_URL + imgName;

                        const baseVal = i * 2;
                        let statType = "ATK";
                        if (role === 'support') statType = i % 2 === 0 ? "Shield" : "Heal";
                        if (role === 'main') statType = i % 2 === 0 ? "Crit Dmg" : "ATK Bonus";
                        if (i > 15) statType = "Skill Haste";

                        let levelValues = [];
                        let statValues = [];

                        for (let lvl = 1; lvl <= 6; lvl++) {
                            let val1 = baseVal + (lvl * 2);
                            let val2 = lvl + 2;
                            levelValues.push([val1, val2]);
                            statValues.push({ type: statType, value: val1 });
                        }

                        const template = role === 'main'
                            ? `Increases ${statType} by {0}% for {1}s.`
                            : `Grant ${statType} equal to {0}% of HP for {1}s.`;

                        potentials.push({
                            id: `${char.id}_${role}_${i}`,
                            charId: char.id,
                            type: role,
                            name: `${char.name} ${role === 'main' ? 'Skill' : 'Buff'} ${i}`,
                            displayNum: i,
                            descTemplate: template,
                            values: levelValues,
                            statData: statValues,
                            rarity: rarity,
                            imgUrl: realUrl,
                            color: rarity === 'super' ? 'f50057' : (rarity === 'rare' ? 'ff4081' : '546e7a')
                        });
                    }
                });
            });
            return potentials;
        }

        const gameData = {
            characters: baseCharacters,
            potentials: generatePotentials()
        };

        /* --- 2. STATE --- */
        let trackers = JSON.parse(localStorage.getItem('stella_trackers')) || [];
        let currentTrackerId = null;

        window.onload = () => {
            populateSelects();
            showDashboard();
        };

        /* --- 3. HELPER FUNCTIONS --- */
        function getFaceImage(char) {
            const realUrl = `${ASSET_BASE_URL}${char.id}_face.png`;
            const placeholder = `https://placehold.co/100x100/333/fff?text=${char.name.substring(0, 2)}`;
            const onError = `this.onerror=null;this.src='${placeholder}';`;
            return { url: realUrl, onError: onError };
        }

        function getCharStats(tracker, charId, role) {
            const charTargets = tracker.targets.filter(t => t.charId === charId);
            const maxedItems = charTargets.filter(t => t.level === MAX_LEVEL).length;
            const baseCap = role === 'main' ? BASE_CAP_MAIN : BASE_CAP_SUPP;
            const currentCap = baseCap + maxedItems;
            const totalCost = charTargets.reduce((sum, t) => sum + t.level, 0);

            return {
                usedSlots: charTargets.length,
                cap: currentCap,
                totalCost: totalCost,
                isFull: charTargets.length >= currentCap
            };
        }

        function resolveDescription(potential, level) {
            if (!potential.values || !potential.descTemplate) return "No description.";
            const vals = potential.values[level - 1];
            let text = potential.descTemplate;
            if (vals) {
                vals.forEach((v, index) => {
                    text = text.replace(`{${index}}`, `<span>${v}</span>`);
                });
            }
            return text;
        }

        function calculateRunStats(tracker) {
            let totals = {};
            tracker.targets.forEach(t => {
                const pot = gameData.potentials.find(p => p.id === t.potentialId);
                if (pot && pot.statData) {
                    const statInfo = pot.statData[t.level - 1];
                    if (statInfo) {
                        totals[statInfo.type] = (totals[statInfo.type] || 0) + statInfo.value;
                    }
                }
            });
            return totals;
        }

        function openStatsModal() {
            const tracker = trackers.find(t => t.id === currentTrackerId);
            if (!tracker) return;
            const totals = calculateRunStats(tracker);
            const modalBody = document.getElementById('statsModalBody');

            if (Object.keys(totals).length === 0) {
                modalBody.innerHTML = '<p class="text-center text-muted">No stats active yet.</p>';
            } else {
                let html = '';
                Object.keys(totals).sort().forEach(key => {
                    html += `
                        <div class="stat-row">
                            <span class="text-secondary">${key}</span>
                            <span class="stat-val">+${totals[key]}%</span>
                        </div>`;
                });
                modalBody.innerHTML = html;
            }
            const modal = new bootstrap.Modal(document.getElementById('statsModal'));
            modal.show();
        }

        /* --- 4. VIEW LOGIC --- */
        function switchView(viewName) {
            ['viewDashboard', 'viewSetup', 'viewTracker'].forEach(id => {
                document.getElementById(id).classList.add('d-none');
            });
            document.getElementById(viewName).classList.remove('d-none');
            updateNavbar(viewName);

            // FIXED: Only scroll to top if we are NOT in the tracker view (prevents jump on reload)
            if (viewName !== 'viewTracker') {
                window.scrollTo(0, 0);
            }
        }

        function updateNavbar(viewName) {
            const navActions = document.getElementById('navActions');
            navActions.innerHTML = '';

            if (viewName === 'viewDashboard') {
                navActions.innerHTML = `
                    <button class="btn btn-outline-info me-2" onclick="triggerImport()">
                        <i class="fa-solid fa-file-import me-2"></i><span class="d-none d-sm-inline">Import</span>
                    </button>
                    <button class="btn btn-primary" onclick="showCreateForm()">
                        <i class="fa-solid fa-plus me-2"></i><span class="d-none d-sm-inline">New</span>
                    </button>`;
            } else if (viewName === 'viewTracker') {
                navActions.innerHTML = `
                    <button class="btn btn-success me-2" onclick="openStatsModal()">
                        <i class="fa-solid fa-chart-simple"></i>
                    </button>
                    <button class="btn btn-outline-light" onclick="showDashboard()">
                        <i class="fa-solid fa-arrow-left"></i>
                    </button>`;
            }
        }

        /* --- 5. TRACKER RENDER --- */
        // FIXED: Added 'preserveScroll' parameter
        function loadTracker(id, preserveScroll = false) {
            currentTrackerId = id;
            const tracker = trackers.find(t => t.id === id);
            if (!tracker) return showDashboard();

            // Save scroll positions before clearing
            let scrollMap = {};
            let winScroll = 0;
            if (preserveScroll) {
                winScroll = window.scrollY;
                document.querySelectorAll('.target-list-container').forEach(el => {
                    scrollMap[el.id] = el.scrollTop;
                });
            }

            const container = document.getElementById('runColumns');
            container.innerHTML = '';
            renderColumn(container, tracker.main, 'main', tracker);
            renderColumn(container, tracker.sup1, 'support', tracker);
            renderColumn(container, tracker.sup2, 'support', tracker);

            switchView('viewTracker');

            // Restore scroll positions
            if (preserveScroll) {
                window.scrollTo(0, winScroll);
                Object.keys(scrollMap).forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.scrollTop = scrollMap[id];
                });
            }
        }

        function renderColumn(container, charId, role, tracker) {
            const char = gameData.characters.find(c => c.id === charId);
            const availablePots = gameData.potentials.filter(p => p.charId === charId && p.type === role);

            const faceData = getFaceImage(char);
            const stats = getCharStats(tracker, charId, role);

            const col = document.createElement('div');
            col.className = 'col-lg-4 col-md-12';
            const badgeClass = role === 'main' ? 'bg-warning text-dark' : 'bg-info text-dark';

            const searchId = `search-${charId}-${role}`;

            // Added unique ID for stats bar to update it easily
            const statsId = `stats-bar-${charId}-${role}`;

            col.innerHTML = `
                <div class="card bg-dark border-secondary h-100">
                    <div class="card-header border-secondary d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-2">
                            <img src="${faceData.url}" onerror="${faceData.onError}" class="rounded-circle border border-secondary" style="width: 40px; height: 40px; object-fit: cover;">
                            <h5 class="mb-0 text-white">${char.name}</h5>
                        </div>
                        <span class="badge ${badgeClass}">${role.toUpperCase()}</span>
                    </div>
                    <div class="card-body d-flex flex-column p-2">
                        <div class="stats-bar" id="${statsId}">
                            ${renderStatsBarContent(stats)}
                        </div>

                        <div class="mb-2">
                            <input type="text" id="${searchId}" class="form-control form-control-sm pool-search" placeholder="Search..." onkeyup="filterPotentials('${charId}', '${role}')">
                        </div>

                        <div id="pools-${charId}-${role}"></div>
                        <div class="border-bottom border-secondary my-2"></div>
                        
                        <small class="text-muted text-uppercase fw-bold mb-1 ps-1" style="font-size:0.7rem;">Target Build</small>
                        <div class="target-list-container" id="target-${charId}-${role}"></div>
                    </div>
                </div>
            `;
            container.appendChild(col);

            const poolsContainer = col.querySelector(`#pools-${charId}-${role}`);
            const roleTitle = role === 'main' ? 'Main' : 'Support';
            const groups = [
                { title: `${roleTitle} Build 1`, data: availablePots.slice(0, 6) },
                { title: `${roleTitle} Build 2`, data: availablePots.slice(6, 12) },
                { title: `General`, data: availablePots.slice(12, 18) },
                { title: null, data: availablePots.slice(18) }
            ];

            groups.forEach(group => {
                if (group.data.length === 0) return;
                const section = document.createElement('div');
                section.className = 'pool-section';
                if (group.title) section.innerHTML = `<div class="pool-section-title">${group.title}</div>`;

                const row = document.createElement('div');
                row.className = 'pool-row';

                group.data.forEach(pot => {
                    const isSelected = tracker.targets.find(t => t.potentialId === pot.id);
                    const placeholder = `https://placehold.co/100x150/${pot.color}/ffffff?text=${pot.displayNum}`;
                    const onError = `this.onerror=null;this.src='${placeholder}';`;

                    let classes = `pool-card ${pot.rarity}`;
                    if (isSelected) classes += ` selected`;

                    const card = document.createElement('div');
                    card.className = classes;
                    card.title = pot.name;

                    card.dataset.name = pot.name.toLowerCase();
                    card.dataset.desc = pot.descTemplate.toLowerCase();

                    card.innerHTML = `<img src="${pot.imgUrl}" onerror="${onError}"><div class="pool-overlay">#${pot.displayNum}</div>`;

                    card.onclick = () => {
                        if (!isSelected) {
                            if (stats.isFull) {
                                Swal.fire({ icon: 'warning', title: 'Capacity Reached', timer: 2000, showConfirmButton: false });
                            } else {
                                addPotential(tracker.id, pot.id, charId);
                            }
                        }
                    };
                    row.appendChild(card);
                });
                section.appendChild(row);
                poolsContainer.appendChild(section);
            });

            const targetContainer = col.querySelector(`#target-${charId}-${role}`);
            const charTargets = tracker.targets.filter(t => t.charId === charId);

            if (charTargets.length === 0) {
                targetContainer.innerHTML = '<div class="text-center text-muted fst-italic py-4" style="font-size:0.8rem">Click cards above to add</div>';
            }

            charTargets.forEach(t => {
                const pot = gameData.potentials.find(p => p.id === t.potentialId);
                const placeholder = `https://placehold.co/50x50/${pot.color}/ffffff?text=${pot.displayNum}`;
                const onError = `this.onerror=null;this.src='${placeholder}';`;

                const isMaxed = t.level === MAX_LEVEL;
                const borderClass = isMaxed ? "border-warning border-2" : "border-0";
                const descHtml = resolveDescription(pot, t.level);

                const item = document.createElement('div');
                item.id = `target-item-${pot.id}`; // Add ID for direct update
                item.className = `card bg-secondary bg-opacity-10 ${borderClass} p-2 mb-2`;
                item.innerHTML = `
                    <div class="d-flex align-items-center gap-2 mb-1">
                        <img src="${pot.imgUrl}" onerror="${onError}" width="35" height="35" class="rounded">
                        <div class="flex-grow-1" style="line-height:1.1;">
                            <div class="text-white fw-bold" style="font-size:0.8rem;">${pot.name}</div>
                            <span id="badge-${pot.id}">${isMaxed ? '<span class="badge bg-warning text-dark" style="font-size:0.6rem">MAX</span>' : ''}</span>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary py-0" onclick="updateLevel('${tracker.id}', '${pot.id}', -1, '${charId}', '${role}')">-</button>
                            <button class="btn btn-dark disabled text-white fw-bold py-0" style="width:25px; font-size:0.8rem;" id="lvl-display-${pot.id}">${t.level}</button>
                            <button class="btn btn-outline-secondary py-0" onclick="updateLevel('${tracker.id}', '${pot.id}', 1, '${charId}', '${role}')">+</button>
                        </div>
                        <button class="btn btn-sm text-danger py-0 px-1" onclick="removePotential('${tracker.id}', '${pot.id}')"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <div class="desc-text" id="desc-${pot.id}">${descHtml}</div>
                `;
                targetContainer.appendChild(item);
            });
        }

        function renderStatsBarContent(stats) {
            return `
                <div class="stat-item text-warning" title="Slots Used / Max Capacity">
                    <i class="fa-solid fa-layer-group"></i> 
                    Slots: <b>${stats.usedSlots} / ${stats.cap}</b>
                </div>
                <div class="stat-item text-info" title="Total Potential Cost">
                    <i class="fa-solid fa-bolt"></i> 
                    Cost: <b>${stats.totalCost}</b>
                </div>
            `;
        }

        /* --- 6. ACTIONS --- */
        function filterPotentials(charId, role) {
            const searchInput = document.getElementById(`search-${charId}-${role}`);
            const filterText = searchInput.value.toLowerCase();
            const container = document.getElementById(`pools-${charId}-${role}`);

            const cards = container.querySelectorAll('.pool-card');
            cards.forEach(card => {
                const name = card.dataset.name;
                const desc = card.dataset.desc;
                if (name.includes(filterText) || desc.includes(filterText)) {
                    card.classList.remove('hidden');
                } else {
                    card.classList.add('hidden');
                }
            });

            const sections = container.querySelectorAll('.pool-section');
            sections.forEach(section => {
                const visibleCards = section.querySelectorAll('.pool-card:not(.hidden)');
                if (visibleCards.length === 0) {
                    section.classList.add('hidden');
                } else {
                    section.classList.remove('hidden');
                }
            });
        }

        function addPotential(trackerId, potId, charId) {
            const tracker = trackers.find(t => t.id === trackerId);
            tracker.targets.push({ potentialId: potId, charId: charId, level: 1 });
            saveData();
            loadTracker(trackerId, true); // preserve scroll
        }

        // FIXED: Unified update logic (uses loadTracker with preserveScroll)
        function updateLevel(trackerId, potId, change, charId, role) {
            const tracker = trackers.find(t => t.id === trackerId);
            const target = tracker.targets.find(t => t.potentialId === potId);

            if (target) {
                let newLevel = target.level + change;
                if (newLevel < 1) newLevel = 1;
                if (newLevel > MAX_LEVEL) newLevel = MAX_LEVEL;

                if (target.level !== newLevel) {
                    target.level = newLevel;
                    saveData();
                    loadTracker(trackerId, true);
                }
            }
        }

        function removePotential(trackerId, potId) {
            const tracker = trackers.find(t => t.id === trackerId);
            tracker.targets = tracker.targets.filter(t => t.potentialId !== potId);
            saveData();
            loadTracker(trackerId, true); // preserve scroll
        }

        /* --- 7. UTILS & DASHBOARD --- */
        function populateSelects() {
            const selects = ['selectMain', 'selectSup1', 'selectSup2'];
            selects.forEach(id => {
                const el = document.getElementById(id);
                el.innerHTML = '';
                gameData.characters.forEach(char => {
                    const opt = document.createElement('option');
                    opt.value = char.id;
                    opt.textContent = char.name;
                    el.appendChild(opt);
                });
            });
        }

        function showDashboard() {
            currentTrackerId = null;
            const list = document.getElementById('trackerList');
            list.innerHTML = '';
            if (trackers.length === 0) {
                list.innerHTML = `<div class="col-12 text-center mt-5 text-muted"><h4>No runs found</h4><p>Start a new journey.</p></div>`;
            }
            trackers.forEach(t => {
                const mainChar = gameData.characters.find(c => c.id === t.main);
                const sup1 = gameData.characters.find(c => c.id === t.sup1);
                const sup2 = gameData.characters.find(c => c.id === t.sup2);

                const mainImg = getFaceImage(mainChar);
                const sup1Img = getFaceImage(sup1);
                const sup2Img = getFaceImage(sup2);

                const col = document.createElement('div');
                col.className = 'col-lg-4 col-md-6';
                col.innerHTML = `
                    <div class="card run-card p-3 h-100">
                        <div class="run-card-actions">
                            <button class="btn btn-sm btn-dark border-secondary" onclick="exportTracker('${t.id}')"><i class="fa-solid fa-download text-info"></i></button>
                            <button class="btn btn-sm btn-dark border-secondary" onclick="deleteTracker('${t.id}')"><i class="fa-solid fa-trash text-danger"></i></button>
                        </div>
                        <div class="cursor-pointer" onclick="loadTracker('${t.id}')">
                            <h5 class="text-white mb-3 pe-5 text-truncate">${t.name}</h5>
                            <div class="d-flex gap-2 mb-2">
                                <img class="char-icon main" src="${mainImg.url}" onerror="${mainImg.onError}">
                                <img class="char-icon supp" src="${sup1Img.url}" onerror="${sup1Img.onError}">
                                <img class="char-icon supp" src="${sup2Img.url}" onerror="${sup2Img.onError}">
                            </div>
                        </div>
                    </div>
                `;
                list.appendChild(col);
            });
            switchView('viewDashboard');
        }

        function exportTracker(id) {
            const tracker = trackers.find(t => t.id === id);
            const exportData = {
                id: tracker.id, name: tracker.name,
                main: tracker.main, sup1: tracker.sup1, sup2: tracker.sup2,
                targets: tracker.targets.map(t => ({ pid: t.potentialId, cid: t.charId, lvl: t.level }))
            };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportData));
            const a = document.createElement('a');
            a.href = dataStr;
            a.download = `stella_run_${tracker.name}.json`;
            a.click();
        }

        function triggerImport() { document.getElementById('importFileInput').click(); }

        function handleFileImport(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imp = JSON.parse(e.target.result);
                    trackers.push({
                        id: 'imp_' + Date.now(), name: imp.name + " (Imp)",
                        main: imp.main, sup1: imp.sup1, sup2: imp.sup2,
                        targets: imp.targets.map(t => ({ potentialId: t.pid, charId: t.cid, level: t.lvl }))
                    });
                    saveData(); showDashboard();
                } catch (err) { Swal.fire('Error', 'Invalid JSON', 'error'); }
            };
            if (file) reader.readAsText(file);
            input.value = '';
        }

        function showCreateForm() { document.getElementById('runName').value = `Run #${trackers.length + 1}`; switchView('viewSetup'); }

        function createTracker() {
            trackers.push({
                id: Date.now().toString(),
                name: document.getElementById('runName').value || 'Untitled',
                main: document.getElementById('selectMain').value,
                sup1: document.getElementById('selectSup1').value,
                sup2: document.getElementById('selectSup2').value,
                targets: []
            });
            saveData(); loadTracker(trackers[trackers.length - 1].id);
        }

        function deleteTracker(id) {
            event.stopPropagation();
            Swal.fire({ title: 'Delete?', showCancelButton: true, confirmButtonText: 'Yes' }).then((r) => {
                if (r.isConfirmed) { trackers = trackers.filter(t => t.id !== id); saveData(); showDashboard(); }
            });
        }
        function saveData() { localStorage.setItem('stella_trackers', JSON.stringify(trackers)); }

    </script>
</body>

</html>